<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å‘‰æ¹¾ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ»ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼ Ultimate</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        :root { --danger: #ff4757; --warning: #ffa502; --safe: #2ed573; --primary: #1e90ff; --text-main: #2f3542; }
        body { font-family: "Helvetica Neue", Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; color: var(--text-main); }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header { background: #2c3e50; color: white; padding: 12px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000; }
        h1 { margin: 0; font-size: 1.2rem; }
        #alert-bar { display: none; background: var(--danger); color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 0.9rem; }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        #main-container { display: flex; overflow: hidden; height: 100vh; width: 100% }
        #sidebar { width: 360px; background: #f1f2f6; padding: 15px; box-shadow: 2px 0 5px rgba(0,0,0,0.1);overflow-y: auto; display: flex; flex-direction: column; gap: 15px; z-index: 1000; flex-shrink: 0;}
        #map { flex: 1; height: 100%;}

        /* UIãƒ‘ãƒ¼ãƒ„ */
        .control-group label { font-weight: bold; font-size: 13px; display: block; margin-bottom: 5px; }
        .control-group input { width: 100%; padding: 10px; border: 1px solid #ced6e0; border-radius: 6px; box-sizing: border-box; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: #3498db; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; }
        .btn-primary:hover { background: #0984e3; }
        .btn-secondary { background: #7bed9f; color: #2f3542; margin-top: 10px; }
        .btn-secondary:hover { background: #2ed573; }

        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .status-card { background: white; padding: 15px; border-radius: 8px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .score-badge { float: right; font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        
        /* ç†ç”±è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .reason-list { margin-top: 8px; padding-top: 8px; border-top: 1px dashed #eee; font-size: 12px; line-height: 1.4; }
        .reason-good { color: var(--safe); }
        .reason-bad { color: var(--danger); }
        .reason-warn { color: var(--warning); }

        /* ãƒãƒ¼ã‚«ãƒ¼ */
        .custom-marker { border-radius: 50%; border: 2px solid white; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; box-shadow: 0 3px 6px rgba(0,0,0,0.3); }
        .hazard-text { color: var(--danger); font-weight: bold; display: block; margin-top: 5px; }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; justify-content:center; align-items:center; z-index: 9999}

        /* é‡£ã‚Šãƒã‚¤ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ï¼ˆã”å¸Œæœ›ã®ãƒ‡ã‚¶ã‚¤ãƒ³ç”¨ï¼‰ */
        .point-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer;
            position: relative;
        }
        .point-card:hover { border-color: #3498db; }

        /*ã€€é‡£æœè©³ç´°ã®å¹ãå‡ºã—*/
        .catch-detail-popup{
            display: none;
            position: absolute;
            top: 35px; /* æ•°å­—ã®ä¸‹ã‚ãŸã‚Šã«è¡¨ç¤º */
            right: 10px;
            background: #333;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 2000;
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .catch-detail-popup::after{
            content: '';
            position: absolute;
            bottom: 100%;
            right: 20px;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent #333 transparent;
        }
        .catch-count-btn{
            background: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
        }
        .catch-count-btn:hover{
            background: #0056b3;
        }

        /* AIãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ï¼ˆå³ä¸‹ã«å›ºå®šï¼‰ */
        #ai-chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #20c997; /* é®®ã‚„ã‹ãªç·‘ */
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 9999;
            font-size: 16px;
            transition: transform 0.2s;
        }
        #ai-chat-toggle:hover {
            transform: scale(1.05);
        }

        /* ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
        #ai-chat-window {
            display: none; /* æœ€åˆã¯éš ã™ */
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 320px;
            height: 450px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 9999;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .ai-chat-header {
            background: #20c997;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        #ai-chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ai-message {
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 13px;
            max-width: 80%;
            line-height: 1.4;
        }

        .ai-message.system {
            background: #e9ecef;
            align-self: flex-start;
            color: #333;
        }

        .ai-message.user {
            background: #007bff;
            color: white;
            align-self: flex-end;
        }

        .ai-chat-input-area {
            padding: 10px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 5px;
            background: white;
        }

        #ai-user-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            outline: none;
        }

    </style>
</head>
<body>

<header>
    <h1>å‘‰æ¹¾ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°</h1>
</header>
<div id="alert-bar"></div>

<div id="main-container">
    <div id="loading-overlay">ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...</div>

    <div id="sidebar">
        <div class="control-group">
            <label>æ—¥æ™‚</label>
            <div style="display: flex; gap: 5px;">
                <input type="date" id="date-input" min="2024-01-01" style="flex: 1;">
                <button onclick="runAnalysis()" class="btn-primary" style="width: auto; padding: 0 10px; font-size: 12px; white-space: nowrap;">
                    æ—¥ä»˜ã‚’æ›´æ–°
                </button>
            </div>
        </div>

        <div class="control-group">
            <label>ç‹™ã†é­šç¨® (ç©ºæ¬„ã§å…¨é­šç¨®)</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="fish-input" placeholder="ä¾‹: ã‚¢ã‚¸, ã‚¿ã‚¤, ãƒ’ãƒ©ãƒ¡">
                <button id="search-btn" class="btn-primary" style="width: 80px;">è§£æ</button>
                <button id="reset-btn" style="background:#76baf6; width: 80px; padding: 5px 0;font-size: 12px; border:none; border-radius:4px; color:white; cursor:pointer;">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <small style="color:#747d8c; font-size:11px;">â€»ã‚¿ã‚³ã€ãƒãƒŒã€ã‚¿ãƒã‚¦ã‚ªãªã©ã‚‚æ¤œç´¢å¯èƒ½</small>
        </div>

        <div id="info-panel">
            <label>æ°—è±¡ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</label>
            <div id="weather-info" class="status-card" style="border-left-color: #747d8c;">
                ãƒ‡ãƒ¼ã‚¿æœªå–å¾—
            </div>

            <label style="margin-top:15px;">å‘‰æ¹¾ã®ãŠã™ã™ã‚ãƒã‚¤ãƒ³ãƒˆè©•ä¾¡</label>
            <div id="ranking-list"></div>
        </div>

        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #ddd;">
            <label>å‘¨è¾ºæ–½è¨­ã‚’æ¤œç´¢</label>
            <div style="display: flex; gap: 5px;">
                <select id="osm-type-select" style="flex: 1; padding: 8px;">
                    <option value="toilets">ãƒˆã‚¤ãƒ¬</option>
                    <option value="parking">é§è»Šå ´</option>
                    <option value="convenience_store">ã‚³ãƒ³ãƒ“ãƒ‹</option>
                </select>
                <button onclick="searchNearbySpots()" class="btn-secondary" style="width: auto; white-space: nowrap;">
                    æ¤œç´¢
                </button>
            </div>
            <small id="osm-status" style="display:block; margin-top:5px; color:#666; font-size:11px;"></small>
        </div>

        <div class="control-group" style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px;">
            <label>ğŸŸ é‡£æœãƒãƒ£ãƒƒãƒˆ(æ¯æ—¥ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™)</label>
            <div id="chat-history" style="height: 150px; overflow-y: auto; background: #f9f9f9; border: 1px solid #eee; padding: 5px; margin-bottom: 5px; font-size: 11px; color: #333;">
                <div style="color:#999; text-align:center; padding-top:20px;">ä»Šæ—¥ã®é‡£æœã‚’å ±å‘Šã—ã‚ˆã†ï¼<br>â€»æ¯æ—¥ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</div>
            </div>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="chat-input" placeholder="ä¾‹: é˜¿è³€ãƒãƒªãƒãƒãƒªã‚¹ã§ã‚¢ã‚¸ãŒ3åŒ¹é‡£ã‚ŒãŸ" style="flex: 1; font-size: 11px">
                <button onclick="postChat()" class="btn-primary" style="width: auto; padding: 0 10px; font-size:11px;">é€ä¿¡</button>
            </div>
        </div>

        <div class="control-group" style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px;">
            <label>ğŸ¤– AIã«ç›¸è«‡</label>
            <div id="ai-chat-messages" style="height: 150px; overflow-y: auto; background: #f1f3f5; border: 1px solid #eee; padding: 5px; margin-bottom: 5px; font-size: 11px; color: #333; display: flex; flex-direction: column; gap: 5px;">
                <div style="background:#e9ecef; padding:8px; border-radius:8px; align-self:flex-start;">ã“ã‚“ã«ã¡ã¯ï¼é¤Œã‚„ä»•æ›ã‘ã®ç›¸è«‡ã«ä¹—ã‚Šã¾ã™ã‚ˆã€‚</div>
            </div>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="ai-user-input" placeholder="ä¾‹ï¼šãƒãƒŒã®ã‚¨ã‚µã¯ä½•ãŒã„ã„ï¼Ÿ" style="flex: 1; font-size: 11px" onkeypress="if(event.key==='Enter') sendToAiAdvisor()">
                <button onclick="sendToAiAdvisor()" class="btn-primary" style="width: auto; padding: 0 10px; font-size:11px; background:#20c997; border-color:#20c997;">ç›¸è«‡</button>
            </div>
        </div>

    </div>

    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

const KURE_API_ENDPOINT = 'https://api.expolis.cloud/opendata/t/kure/v1/water-temperature-1';
const KURE_API_TOKEN = 'ç§ã®apiã‚­ãƒ¼';

// --- 1. ãƒ‡ãƒ¼ã‚¿å®šç¾© (DBç›¸å½“) ---
const FISHING_SPOTS = [
    { id: 1, name: "é˜¿è³€ãƒãƒªãƒãƒãƒªã‚¹", lat: 34.213783, lng: 132.593513, targets:["ã‚¢ã‚¸","ã‚¤ãƒ¯ã‚·","ã‚¿ãƒã‚¦ã‚ª","ãƒ¡ãƒãƒ«","ãƒãƒŒ","ã‚¢ã‚ªãƒªã‚¤ã‚«","ã‚³ã‚¦ã‚¤ã‚«"], note: "è¶³å ´è‰¯ã—ã€‚ãƒ•ã‚¡ãƒŸãƒªãƒ¼å‘ã‘ã€‚é§è»Šå ´ã‹ã‚‰é‡£ã‚Šå ´ã¾ã§å°‘ã—è·é›¢ãŒã‚ã‚‹ã€‚" },
];

// é­šç¨®ã”ã¨ã®é©æ­£ãƒ‡ãƒ¼ã‚¿ (æ‹¡å¼µç‰ˆ)
const FISH_DB = {
    "ã‚¢ã‚¸":   { min: 17, max: 24, season: [3,4,5,9,10,11], habitat: "ä¸­å±¤"},
};

// --- 2. ãƒãƒƒãƒ—åˆæœŸåŒ– ---
const map = L.map('map').setView([34.22, 132.58], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);


// æµ·ã—ã‚‹APIã®æµ·æµãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
const tidalLayer = L.tileLayer.wms("https://api.msil.go.jp/oceanography/tidal-stream/prediction/seto-island-sea/v2/wms", {
    layers: '0', // æµ·æµã®ãƒ¬ã‚¤ãƒ¤ãƒ¼å
    format: 'image/png',
    transparent: true,
    opacity: 0.8, // å°‘ã—é€ã‘ã•ã›ã‚‹
    styles: 'style-arrow-blue',
    ocp_apim_subscription_key: 'ç§ã®apiã‚­ãƒ¼',
}).addTo(map);


//ãƒãƒ£ãƒƒãƒˆæŠ•é™å¾Œã«ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let markersMap = {};
let lastSpotsData = [];

// ãƒãƒ¼ã‚«ãƒ¼ç®¡ç†ç”¨ã‚°ãƒ«ãƒ¼ãƒ—
const mainLayer = L.layerGroup().addTo(map); // å‘‰å¸‚ã®ä¸»è¦ãƒã‚¤ãƒ³ãƒˆç”¨
const osmLayer = L.layerGroup().addTo(map);  // OSMæ¤œç´¢çµæœç”¨

// --- 3. ãƒ¡ã‚¤ãƒ³å‡¦ç† (è§£æãƒœã‚¿ãƒ³) ---
document.getElementById('search-btn').addEventListener('click', runAnalysis);
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('date-input').value = new Date().toISOString().split('T')[0];
    runAnalysis();
});

document.getElementById('reset-btn').addEventListener('click', () =>{
    document.getElementById('fish-input').value = "";
    runAnalysis();
})

function renderResults(spots, weather) {
    // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ãŠã
    lastSpotsData = spots;

    if (typeof markersMap === 'undefined') markersMap = {};
    if (typeof mainLayer !== 'undefined') mainLayer.clearLayers();

    const listEl = document.getElementById('ranking-list');
    if (!listEl) return;
    listEl.innerHTML = '';

    spots.sort((a, b) => b.score - a.score);

    spots.forEach(spot => {
        try {
            let color = '#ff4757';
            if (spot.score >= 70) color = '#2ed573';
            else if (spot.score >= 40) color = '#ffa502';

            // ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
            const dbCatch = dailyCatchData[spot.name] || { total: 0, details: {} };
            const currentTotal = Math.max(dbCatch.total, spot.catchCount || 0);
            const hasCatch = currentTotal > 0;

            // ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ (æ—¢å­˜ãƒãƒ)
            const icon = L.divIcon({
                html: `<div class="custom-marker" style="background:${color}; width:32px; height:32px; border-radius:50%; display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; border:2px solid white;">${Math.floor(spot.score)}</div>`,
                className: ''
            });
        
            const catchText = hasCatch ? `<br><b>ğŸŸ ä»Šæ—¥ã®é‡£æœ: ${currentTotal}åŒ¹</b>` : "";
            const popupContent = `
                <b>${spot.name}</b><br>
                è©•ä¾¡: ${spot.score}ç‚¹ / æ°´æ¸©: ${spot.temp.toFixed(1)}â„ƒ<br>
                ${catchText}
                <div style="margin-top:5px; font-size:11px;">${spot.reasons.join('<br>')}</div>
            `;

            const marker = L.marker([spot.lat, spot.lng], { icon: icon, scoreValue: spot.score})
                .bindPopup(popupContent)
                .addTo(mainLayer);
        
            markersMap[spot.name] = marker;

            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã‚«ãƒ¼ãƒ‰
            const item = document.createElement('div');
            item.className = 'status-card';
            item.style.borderLeftColor = color;
            item.style.cursor = 'pointer';

            item.onclick = (e) => {
                // ãƒœã‚¿ãƒ³ï¼ˆæ•°å­—ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã¯åœ°å›³ç§»å‹•ãªã©ã‚’ç™ºå‹•ã•ã›ãªã„
                if(e.target.classList.contains('catch-count-btn')) return;
                if(typeof focusPoint === 'function') focusPoint(spot.name);
                if(typeof toggleNote === 'function') toggleNote(spot.id || spot.name);
            };

            // --- é‡£æœè¡¨ç¤ºç”¨ã®HTML (ã“ã“ãŒAIå¯¾å¿œã®ãƒã‚¤ãƒ³ãƒˆ) ---
            let catchHtml = "";
            if (hasCatch) {
                // AIãŒè§£æã—ãŸå†…è¨³ï¼ˆdetailsï¼‰ã‚’ã€Œé­šç¨®:åŒ¹æ•°ã€ã®å½¢å¼ã«å¤‰æ›
                const detailsStr = Object.entries(dbCatch.details || {})
                    .map(([fish, num]) => `${fish}:${num}åŒ¹`)
                    .join('ã€');
            
                catchHtml = `
                    <div style="margin-top:5px; font-size:12px; font-weight:bold; color:#0056b3; display:flex; flex-direction:column;">
                        <div>ä»Šæ—¥ã®é‡£æœå ±å‘Š: 
                            <span class="catch-count-btn" 
                                  onclick="toggleCatchDetail(this, '${detailsStr}')" 
                                  data-count="${currentTotal}åŒ¹"
                                  style="background:#007bff; color:white; padding:2px 8px; border-radius:10px; margin-left:5px; font-size:11px; cursor:pointer;">
                                ${currentTotal}
                            </span>
                        </div>
                        <div class="catch-detail-info" style="display:none; margin-top:5px; padding:5px; background:#f0f7ff; border-radius:4px; font-size:11px; color:#333;"></div>
                    </div>
                `;
            } else {
                catchHtml = `<div style="margin-top:5px; font-size:12px; color:#999;">ä»Šæ—¥ã®é‡£æœå ±å‘Š: 0</div>`;
            }

            item.innerHTML = `
                <span class="score-badge" style="color:${color}; float:right; font-size:18px; font-weight:bold;">${Math.floor(spot.score)}ç‚¹</span>
                <strong>${spot.name}</strong>
                <div style="font-size:12px; color:#666;">æ°´æ¸©: ${spot.temp.toFixed(1)}â„ƒ</div>
                ${catchHtml}
                <div class="reason-list" style="font-size:12px; margin-top:5px;">${spot.reasons.join('<br>')}</div>
                <div id="note-${spot.id || spot.name}" style="display:none; margin-top:10px; padding-top:10px; border-top:1px dashed #ccc; font-size:12px;">
                    <strong>ğŸŸ ç‹™ãˆã‚‹é­š:</strong> ${spot.targets ? spot.targets.join('ã€') : 'æƒ…å ±ãªã—'}<br>
                    <strong>ğŸ“ ãƒ¡ãƒ¢:</strong> ${spot.note || 'è©³ç´°æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}
                </div>
            `;
            listEl.appendChild(item);

        } catch (e) {
            console.error("å€‹åˆ¥ã‚¹ãƒãƒƒãƒˆæç”»ã‚¨ãƒ©ãƒ¼:", e);
        }
    });
}

function toggleCatchDetail(btn, detailsStr) {
    // ãƒœã‚¿ãƒ³ã®è¦ªã®è¦ªï¼ˆdivï¼‰ã®ä¸­ã«ã‚ã‚‹ã€Œcatch-detail-infoã€ã¨ã„ã†ã‚¯ãƒ©ã‚¹ã®ã‚¨ãƒªã‚¢ã‚’æ¢ã™
    const detailDiv = btn.parentElement.parentElement.querySelector('.catch-detail-info');
    
    if (detailDiv.style.display === 'none') {
        detailDiv.style.display = 'block';
        detailDiv.innerHTML = `<strong>ğŸ“Š å†…è¨³:</strong><br>${detailsStr || 'è©³ç´°ãªã—'}`;
        btn.innerText = 'é–‰ã˜ã‚‹';
    } else {
        detailDiv.style.display = 'none';
        // data-countå±æ€§ã«ä¿å­˜ã—ã¦ãŠã„ãŸå…ƒã®æ•°å­—ã‚’è¡¨ç¤ºã™ã‚‹
        btn.innerText = btn.getAttribute('data-count').replace('åŒ¹', ''); 
    }
}

// --- è©³ç´°å†…è¨³ã‚’é–‹é–‰ã™ã‚‹é–¢æ•° ---
function toggleCatchDetail(btn, detailsStr) {
    // ãƒœã‚¿ãƒ³ã®ã™ãä¸‹ã«ã‚ã‚‹è©³ç´°ã‚¨ãƒªã‚¢ã‚’æ¢ã™
    const detailDiv = btn.parentElement.nextElementSibling;
    
    if (detailDiv.style.display === 'none') {
        detailDiv.style.display = 'block';
        detailDiv.innerHTML = `<strong>å†…è¨³:</strong> ${detailsStr || 'è©³ç´°ãªã—'}`;
        btn.innerText = 'é–‰ã˜ã‚‹';
    } else {
        detailDiv.style.display = 'none';
        btn.innerText = btn.getAttribute('data-count'); // å…ƒã®æ•°å­—ã«æˆ»ã™
    }
}

//ã€€ã“ã‚ŒãŒå…ƒã®ã‚„ã¤
function toggleNote(id){
    const noteEl = document.getElementById(`note-${id}`);
    if(noteEl){
        if(noteEl.style.display === 'none'){
            noteEl.style.display = 'block';
        }else{
            noteEl.style.display = 'none';
        }
    }
}

// --- 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨åˆæœŸåŒ–å‡¦ç† ---
let dailyCatchData = {}; // é‡£æœãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
window.addEventListener('load', () => {
    initChatSystem();
});

function initChatSystem() {
    const today = new Date().toDateString();
    const lastDate = localStorage.getItem('chatDate');

    // æ—¥ä»˜ãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
    if (lastDate !== today) {
        localStorage.setItem('chatDate', today);
        localStorage.removeItem('chatLog');
        localStorage.removeItem('catchData');
        dailyCatchData = {};
    } else {
        // åŒã˜æ—¥ãªã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
        const savedLog = JSON.parse(localStorage.getItem('chatLog')) || [];
        const savedData = JSON.parse(localStorage.getItem('catchData')) || {};
        dailyCatchData = savedData;
        
        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¡¨ç¤º
        const chatBox = document.getElementById('chat-history');
        if(chatBox) {
            chatBox.innerHTML = '';
            savedLog.forEach(msg => addMessageToDOM(msg));
        }
    }
}

// ç”»é¢èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
window.addEventListener('load', initChatSystem);

async function postChat() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text) return;

    // 1. å³åº§ã«ãƒãƒ£ãƒƒãƒˆç”»é¢ã«è¡¨ç¤º
    addMessageToDOM({
        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        text: text
    });

    // 2. ã‚¹ãƒãƒƒãƒˆåã®ãƒªã‚¹ãƒˆã‚’æº–å‚™ï¼ˆAIã«ã€Œã“ã®ä¸­ã‹ã‚‰é¸ã‚“ã§ã€ã¨æ•™ãˆã‚‹ãŸã‚ï¼‰
    const spotNames = FISHING_SPOTS.map(s => s.name);

    // 3. AIã«è§£æã‚’ä¾é ¼
    const aiResult = await analyzeTextWithAI(text, spotNames);

    if (aiResult && aiResult.spot) {
        // AIãŒé¸ã‚“ã æ­£ç¢ºãªã‚¹ãƒãƒƒãƒˆåã§ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        updateCatchDataFromAI(aiResult.spot, aiResult.fish_data);
        
        // AIã®è¿”ç­”ã‚’è¡¨ç¤º
        const replyText = aiResult.fish_data.map(f => `${f.fish}${f.count}åŒ¹`).join('ã€');
        addMessageToDOM({
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            text: `ğŸ¤– é‡£æœã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ (${aiResult.spot}: ${replyText})`
        });

        // ç”»é¢ã‚’å†æç”»
        if (typeof lastSpotsData !== 'undefined') {
            renderResults(lastSpotsData);
        }
    }
    input.value = '';
}

// AIã®çµæœã‚’ dailyCatchData ã«ä¿å­˜ã™ã‚‹å°‚ç”¨é–¢æ•°
function updateCatchDataFromAI(spotName, fishDataList) {
    if (!dailyCatchData[spotName]) {
        dailyCatchData[spotName] = { total: 0, details: {} };
    }

    fishDataList.forEach(item => {
        const count = parseInt(item.count);
        dailyCatchData[spotName].total += count;
        
        // å†…è¨³ã‚’æ›´æ–°ï¼ˆæ—¢å­˜ã®æ•°ã«åŠ ç®—ï¼‰
        if (!dailyCatchData[spotName].details[item.fish]) {
            dailyCatchData[spotName].details[item.fish] = 0;
        }
        dailyCatchData[spotName].details[item.fish] += count;
    });

    localStorage.setItem('catchData', JSON.stringify(dailyCatchData));
}

// ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¦localStorageã«ä¿å­˜ã™ã‚‹é–¢æ•°
function updateCatchData(result) {
    const spotName = result.spot;
    const fishName = result.fish;
    const count = parseInt(result.count, 10) || 0;

    if (count <= 0) return;

    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®åˆæœŸåŒ–
    if (!dailyCatchData[spotName]) {
        dailyCatchData[spotName] = { total: 0, details: {} };
    }

    // åˆè¨ˆã‚’åŠ ç®—
    dailyCatchData[spotName].total += count;

    // é­šç¨®ã”ã¨ã®å†…è¨³ã‚’åŠ ç®—
    if (!dailyCatchData[spotName].details[fishName]) {
        dailyCatchData[spotName].details[fishName] = 0;
    }
    dailyCatchData[spotName].details[fishName] += count;

    // ä¿å­˜
    localStorage.setItem('catchData', JSON.stringify(dailyCatchData));
}

// AIè§£æé–¢æ•°ï¼šè¡¨è¨˜æºã‚Œã¨è¤‡æ•°é­šç¨®ã«å¯¾å¿œ
async function analyzeTextWithAI(text, spotList) {
    const API_KEY = 'ç§ã®apiã‚­ãƒ¼';
    
    const prompt = `
    é‡£ã‚Šäººã®å ±å‘Šã‹ã‚‰ã€é‡£ã‚Šå ´ã€‘ã€é­šç¨®ã€‘ã€åŒ¹æ•°ã€‘ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
    
    1. "spot": ä»¥ä¸‹ã®ãƒªã‚¹ãƒˆã®ä¸­ã‹ã‚‰ã€å ±å‘Šã«æœ€ã‚‚è¿‘ã„å ´æ‰€åã‚’1ã¤é¸ã‚“ã§ãã ã•ã„ã€‚
       ãƒªã‚¹ãƒˆ: [${spotList.join(', ')}]
    2. "fish_data": é‡£ã‚ŒãŸé­šã¨æ•°ã®ãƒªã‚¹ãƒˆã‚’ JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚
    
    å ±å‘Šä¾‹: ã€Œè±Šå³¶æ¸¯ã§ã‚¢ã‚¸1ã¨ãƒã‚°ãƒ­1åŒ¹ã€
    è¿”å´ä¾‹: {"spot": "è±Šå³¶ãƒ»è±Šå³¶æ¸¯", "fish_data": [{"fish": "ã‚¢ã‚¸", "count": 1}, {"fish": "ãƒã‚°ãƒ­", "count": 1}]}
    `;

    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-3.5-turbo",
                messages: [
                    { role: "system", content: prompt },
                    { role: "user", content: text }
                ],
                temperature: 0
            })
        });
        const data = await response.json();
        return JSON.parse(data.choices[0].message.content);
    } catch (e) {
        console.error("AIè§£æå¤±æ•—:", e);
        return null;
    }
}

//è¡¨ç¤ºé–¢é€£(renderResultsã¨toggleCatchDetail)
function addMessageToDOM(msg) {
    const chatBox = document.getElementById('chat-history');
    const div = document.createElement('div');
    div.style.marginBottom = "5px";
    div.style.borderBottom = "1px dotted #eee";
    div.innerHTML = `<span style="color:#666; font-size:10px;">[${msg.time}]</span> ${msg.text}`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

// æ–‡ç« è§£æãƒ­ã‚¸ãƒƒã‚¯
function analyzeAndRegisterCatch(text) {
    let updated = false;

    // 1. ã©ã®ãƒã‚¤ãƒ³ãƒˆã®è©±ã‹ç‰¹å®šã™ã‚‹
    // FISHING_SPOTS ã¯æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã¯ãš
    const spot = FISHING_SPOTS.find(s => text.includes(s.name));
    if (spot) {
        // ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
        if (!dailyCatchData[spot.id]) {
            dailyCatchData[spot.id] = { total: 0, details: {} };
        }

        // 2. é­šã¨æ•°ã‚’æ¢ã™
        // ç°¡æ˜“çš„ãªé­šãƒªã‚¹ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã—ã¦ãã ã•ã„ï¼‰
        const fishes = ["ã‚¢ã‚¸", "ã‚µãƒ¨ãƒª", "ã‚¤ãƒ¯ã‚·", "ãƒ¡ãƒãƒ«", "ãƒãƒŒ", "ã‚¿ã‚¤", "ã‚­ã‚¹", "ã‚«ãƒ¬ã‚¤", "ã‚¿ã‚³", "ã‚¤ã‚«", "ãƒãƒãƒ", "ã‚·ãƒ¼ãƒã‚¹"];
    
        fishes.forEach(fishName => {
            //"ãƒã‚°ãƒ­1åŒ¹" "ãƒã‚°ãƒ­ãŒ2ã²ã" ãªã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œç´¢
            if (text.includes(fishName)) {
                // æ•°å­—ã‚’æ¢ã™æ­£è¦è¡¨ç¾ï¼ˆæ¼¢æ•°å­—å¯¾å¿œï¼‰
                const regex = new RegExp(`(${fishName}.*?(\\d+|[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)|(\\d+|[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+).*?${fishName})`, 'g');
                const match = text.match(regex); // ãƒãƒƒãƒã—ãŸéƒ¨åˆ†ã‚’å–å¾—

                if(match){
                    //æ–‡å­—åˆ—ã‹ã‚‰æ•°å­—ã ã‘ã‚’æŠ½å‡ºã—ã¦è¶³ã™
                    const numMatch = match[0].match(/(\d+|[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)/);
                    if(numMatch){
                        const count = parseNumber(numMatch[0]);
                        dailyCatchData[spot.name].total += count;
                        dailyCatchData[spot.name].details.push(`${fishName}: ${count}`);
                        updated = true;
                    }
                }
            }
        });

        if(updated){
            localStorage.setItem('catchData', JSON.stringify(dailyCatchData));
            //â˜…ãƒªã‚¹ãƒˆã‚’å†æç”»ã—ã¦æ•°å­—ã‚’æ›´æ–°ï¼
            if(currentSpotsData.length > 0){
                renderResults(currentSpotsData);
            }
        }
    }
}

// æ¼¢æ•°å­—ã‚’æ•°å­—ã«å¤‰æ›ã™ã‚‹è£œåŠ©é–¢æ•°
function parseNumber(str) {
    if (!isNaN(str)) return parseInt(str, 10);
    const kanji = { 'ä¸€':1, 'äºŒ':2, 'ä¸‰':3, 'å››':4, 'äº”':5, 'å…­':6, 'ä¸ƒ':7, 'å…«':8, 'ä¹':9, 'å':10 };
    return kanji[str] || 0;
}

function clearOsmSpots(){
    osmLayer.clearLayers();
    document.getElementById('osm-clear-btn').style.display = 'none';
    document.getElementById('osm-status').innerText = "è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚";
}

function toggleOsmButtons(hasData){
}

async function fetchWeather(dateValue) {
    // æ—¥ä»˜ã‚’ YYYY-MM-DD å½¢å¼ã«æ•´å½¢
    const targetDate = new Date(dateValue);
    const dateStr = targetDate.toISOString().split('T')[0];
    
    // å‘‰å¸‚ã®åº§æ¨™
    const lat = 34.23;
    const lon = 132.56;

    try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,windspeed_10m_max,weathercode&timezone=Asia%2FTokyo&start_date=${dateStr}&end_date=${dateStr}`;
        
        const response = await fetch(url);
        if (!response.ok) throw new Error("Weather API Error");
        
        const data = await response.json();
        
        return {
            temp_max: data.daily.temperature_2m_max[0],
            temp_min: data.daily.temperature_2m_min[0],
            temp_avg: ((data.daily.temperature_2m_max[0] + data.daily.temperature_2m_min[0]) / 2).toFixed(1),
            precipitation_prob: data.daily.precipitation_probability_max[0],
            wind_speed: data.daily.windspeed_10m_max[0],
            weather_code: data.daily.weathercode[0]
        };
    } catch (error) {
        console.error("å¤©æ°—å–å¾—å¤±æ•—:", error);
        return { temp_avg: "--", wind_speed: "--", precipitation_prob: "--" };
    }
}

async function getWaterTempFinal() {
    // 1. ã¾ãš Kure-API ã‚’è©¦ã™ (401ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™)
    try {
        const response = await fetch("https://api.expolis.cloud/opendata/t/kure/v1/water-temperature-1", {
            headers: { 
                'Authorization': `Bearer ${KURE_API_TOKEN}`,
                'Accept': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            return FISHING_SPOTS.map(spot => {
                const senserData = data.find(d => d.device_id === spot.id);
                return { 
                    id: spot.id, 
                    temp: (senserData && senserData.water_temperatures[0]) ? senserData.water_temperatures[0].surface.value : 18.0 
                };
            });
        }
    } catch (e) { console.warn("Kure-APIä¸å¯ã€‚"); }

    // 2. æµ·ã—ã‚‹API (ç”»åƒã®æƒ…å ±ã‚’åæ˜ ã—ãŸä¿®æ­£ç‰ˆ)
    try {
        // ç”»åƒã«åŸºã¥ã„ãŸè¨­å®š
        const baseUrl = "https://api.msil.go.jp/water-temperature-link/v2/MapServer/0/query";
        const params = new URLSearchParams({
            f: "json",
            where: "1=1",
            // ç”»åƒã®ã‚ˆã†ã«ç¯„å›²(Envelope)ã§æŒ‡å®š
            geometry: "132.3,34.1,133.0,34.4", 
            geometryType: "esriGeometryEnvelope",
            inSR: "4326",
            spatialRel: "esriSpatialRelIntersects",
            outFields: "w_temp,obs_time_dts",
            orderByFields: "obs_time_dts DESC",
            resultRecordCount: "1"
        });

        const res = await fetch(`${baseUrl}?${params.toString()}`, {
            headers: {
                'Ocp-Apim-Subscription-Key': 'ã‚ãªãŸã®APIã‚­ãƒ¼' // â˜…ã“ã“ã«ã‚­ãƒ¼ã‚’å…¥åŠ›
            }
        });

        const msilData = await res.json();
        let backupTemp = 18.0;

        if (msilData.features && msilData.features.length > 0) {
            backupTemp = msilData.features[0].attributes.w_temp || 18.0;
            console.log(`âœ… æµ·ã—ã‚‹å–å¾—æˆåŠŸ: ${backupTemp}åº¦`);
        }

        return FISHING_SPOTS.map(spot => ({ id: spot.id, temp: backupTemp }));

    } catch (err) {
        console.error("æµ·ã—ã‚‹APIå¤±æ•—:", err);
        return FISHING_SPOTS.map(spot => ({ id: spot.id, temp: 18.0 }));
    }
};

function updateWeatherUI(weather){
    const el = document.getElementById('weather-info');
    const alertBar = document.getElementById('alert-bar');

    let rainAdvice = "";
    let adviceColor = "";

    if(weather.rainProb >= 70){
        rainAdvice = "âŒ ã€é‡£è¡Œã¯ãŠã™ã™ã‚ã—ã¾ã›ã‚“ã€‘ æœ¬é™ã‚Šã®é›¨ã«ãªã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚è¦–ç•Œã‚‚æ‚ªããªã‚‹ãŸã‚ä¸­æ­¢ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚";
        adviceColor = "#ff4757";
    }else if(weather.rainProb >= 40){
        rainAdvice = "âš ï¸ ã€ãƒ¬ã‚¤ãƒ³ã‚¦ã‚§ã‚¢å¿…é ˆã€‘ é›¨ãŒé™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å‚˜ã‚ˆã‚Šã‚‚ã€å‹•ãã‚„ã™ã„ãƒ¬ã‚¤ãƒ³ã‚³ãƒ¼ãƒˆã‚’æº–å‚™ã—ã¦ãã ã•ã„ã€‚";
        adviceColor = "#ffa502";
    }else if(weather.rainProb >= 20){
        rianAdvice = "ğŸ’¡ ã€æŠ˜ã‚ŠãŸãŸã¿å‚˜ãŒã‚ã‚‹ã¨å®‰å¿ƒã€‘ æ€¥ãªå°é›¨ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æº–å‚™ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚";
        adviceColor = "#2e86de";
    }else {
        rainAdvice = "âœ¨ ã€é›¨ã®å¿ƒé…ãªã—ã€‘ å‚˜ã¯ä¸è¦ã§ã™ã€‚å¿«é©ã«é‡£ã‚Šã‚’æ¥½ã—ã‚ã¾ã™ã€‚";
        adviceColor = "#2ed573";
    }

    let tempAdvice = "";
    let tempColor = "";

    if(weather.temp >= 30){
        tempAdvice = "ğŸ”¥ ã€ç†±ä¸­ç—‡å³é‡è­¦æˆ’ã€‘ ã“ã¾ã‚ã«æ°´åˆ†ãƒ»å¡©åˆ†è£œçµ¦ã‚’ï¼ç„¡ç†ã›ãšæ—¥é™°ã§ä¼‘æ†©ã—ã¦ãã ã•ã„ã€‚";
        tempColor = "ff4757";
    }else if (weather.temp >= 25) {
        tempAdvice = "â˜€ï¸ ã€å¤æ—¥ã€‘ æš‘ããªã‚Šã¾ã™ã€‚å¸½å­ã‚’ç€ç”¨ã—ã€æ°´åˆ†è£œçµ¦ã‚’å¿˜ã‚Œãšã«ã€‚";
        tempColor = "#ffa502"; // ã‚ªãƒ¬ãƒ³ã‚¸
    } else if (weather.temp <= 10) {
        tempAdvice = "â„ï¸ ã€æ¥µå¯’æ³¨æ„ã€‘ æŒ‡å…ˆã‚„è¶³å…ƒãŒå†·ãˆã¾ã™ã€‚ã‚«ã‚¤ãƒ­ã‚„åšæ‰‹ã®é˜²å¯’ç€ã§å¯¾ç­–ã‚’ã€‚";
        tempColor = "#2e86de"; // é’
    } else if (weather.temp <= 15) {
        tempAdvice = "ğŸ§¥ ã€è‚Œå¯’ã„ã€‘ ä¸Šç€ãŒå¿…è¦ã§ã™ã€‚æµ·è¾ºã¯é¢¨ã§ä½“æ„Ÿæ¸©åº¦ãŒä¸‹ãŒã‚Šã¾ã™ã€‚";
        tempColor = "#54a0ff"; // æ°´è‰²
    } else {
        tempAdvice = "ğŸ€ ã€å¿«é©ã€‘ éã”ã—ã‚„ã™ã„æ°—æ¸©ã§ã™ã€‚";
        tempColor = "#2ed573"; // ç·‘
    }


    el.innerHTML = `
        <div>æ°—æ¸©: <b>${weather.temp}â„ƒ</b></div>
        <div>é¢¨é€Ÿ: <b>${weather.wind}m/s</b></div>
        <div>é™æ°´ç¢ºç‡: <b>${weather.rainProb}%</b></div>
    `;

    

    let bgColor = '#8ed04d';
    let message = '';
    let description = '';

    if (weather.wind >= 15) {
        bgColor = '#800080';
        message = 'âš ï¸ ã€æ¥µã‚ã¦å±é™ºã€‘ å¤–å‡ºç¦æ­¢ãƒ¬ãƒ™ãƒ«';
        description = 'ï¼ˆçœ‹æ¿ã‚„ãƒˆã‚¿ãƒ³ãŒå¤–ã‚Œã€è»¢å€’ã™ã‚‹äººã‚‚ã„ã‚‹çŒ›çƒˆãªé¢¨ã§ã™ã€‚å‘½ã‚’å®ˆã‚‹è¡Œå‹•ã‚’ï¼ï¼‰';

    } else if(weather.wind >= 10){
        bgColor = '#ff4757';
        message = 'âš ï¸ ã€å¼·é¢¨è­¦å ±ãƒ¬ãƒ™ãƒ«ã€‘ é‡£è¡Œä¸å¯';
        description = 'ï¼ˆå‚˜ãŒå£Šã‚Œã‚‹å¼·ã•ã§ã€ä½“ãŒç…½ã‚‰ã‚Œãƒ•ãƒ©ã¤ãé¢¨ã§ã™ã€‚æ³¢æ­¢ã‹ã‚‰ã®è»¢è½ã®å±é™ºãŒéå¸¸ã«é«˜ã„ã§ã™ï¼ï¼‰';
    } else if(weather.wind >= 6){
        bgColor = '#ffa502';
        message = 'âš ï¸ ã€æ³¨æ„ã€‘ é¢¨ãŒå¼·ã¾ã£ã¦ã„ã¾ã™';
        description = 'ï¼ˆç ‚åŸƒãŒç«‹ã¡ã€é¤Œç®±ã‚„è»½ã„è·ç‰©ãŒé£›ã°ã•ã‚Œã‚‹é¢¨ã§ã™ã€‚ç„¡ç†ãªé‡£è¡Œã¯æ§ãˆã¾ã—ã‚‡ã†ã€‚ï¼‰';
    } else {
        bgColor = '#8ed04d';
        message = 'âœ… ã€å®‰å…¨ã€‘ é‡£è¡Œå¯èƒ½';
        description = 'ï¼ˆç©ã‚„ã‹ãªãã‚ˆé¢¨ã§ã™ã€‚ä»•æ›ã‘ã‚‚æŠ•ã’ã‚„ã™ãã€å®‰å…¨ã«é‡£ã‚Šã‚’æ¥½ã—ã‚ã¾ã™ã€‚ï¼‰';
    }

    alertBar.style.display = 'block';
    alertBar.style.backgroundColor = bgColor;
    alertBar.style.color = '#fff';
    alertBar.style.padding = '10px';
    alertBar.style.textAlign = 'center';
    alertBar.style.fontWeight = 'bold';

    alertBar.innerHTML = `
        <span>${message} ç¾åœ¨ã€é¢¨é€Ÿ ${weather.wind}m/s ã§ã™ã€‚</span>
        <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">${description}</div>
    `;
}

function showLoading(show) {
    document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
}


// --- AIé‡£ã‚Šç›¸è«‡ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ ---
// ãƒãƒ£ãƒƒãƒˆçª“ã®é–‹é–‰
function toggleAiChat() {
    const win = document.getElementById('ai-chat-window');
    if (win.style.display === 'none' || win.style.display === '') {
        win.style.display = 'flex';
        document.getElementById('ai-user-input').focus();
    } else {
        win.style.display = 'none';
    }
}

// Enterã‚­ãƒ¼ã§é€ä¿¡
function handleAiEnter(e) {
    if (e.key === 'Enter') sendToAiAdvisor();
}

//ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã®åˆ¶å¾¡
function switchChatTab(type){
    const logTab = document.getElementById('tab-log');
    const aiTab = document.getElementById('tab-ai');
    const logPanel = document.getElementById('panel-log');
    const aiPanel = document.getElementById('panel-ai');

    if(type === 'log'){
        logPanel.style.display = 'flex';
        aiPanel.style.display = 'none';
        logTab.style.background = '#fff';
        aiTab.style.background = '#f1f3f5';
    }else{
        logPanel.style.display = 'none';
        aiPanel.style.display = 'flex';
        logTab.style.background = '#f1f3f5';
        aiTab.style.background = '#fff';
    }
}

// --- 2. AIç›¸è«‡ç”¨ã®é€ä¿¡å‡¦ç†ï¼ˆé‡£æœè§£æã¨ã¯åˆ¥ã®ç”¨é€”ï¼‰ ---
async function sendToAiAdvisor() {
    const input = document.getElementById('ai-user-input');
    const text = input.value.trim();
    if (!text) return;

    // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    addAiMessageToDOM(text, 'user');
    input.value = '';

    const API_KEY = 'ç§ã®apiã‚­ãƒ¼'; // å…±é€šã®APIã‚­ãƒ¼å¤‰æ•°ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨

    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
            body: JSON.stringify({
                model: "gpt-3.5-turbo",
                messages: [
                    { role: "system", content: "ã‚ãªãŸã¯å‘‰å¸‚ã®ãƒ™ãƒ†ãƒ©ãƒ³é‡£ã‚Šå¸«ã§ã™ã€‚é‡£ã‚Šæ–¹ã‚„ã‚¨ã‚µã®è³ªå•ã«ã€å…·ä½“çš„ã‹ã¤è¦ªåˆ‡ã«ç­”ãˆã¦ãã ã•ã„ã€‚" },
                    { role: "user", content: text }
                ],
                temperature: 0.7
            })
        });

        const data = await response.json();
        const aiReply = data.choices[0].message.content;
        addAiMessageToDOM(aiReply, 'system');
    } catch (error) {
        addAiMessageToDOM("ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€ã†ã¾ãç­”ãˆã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚", 'system');
    }
}

// AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«å‡ºã™è£œåŠ©é–¢æ•°
function addAiMessageToDOM(text, role) {
    const container = document.getElementById('ai-chat-messages');
    const div = document.createElement('div');
    div.style.padding = "8px";
    div.style.borderRadius = "8px";
    div.style.maxWidth = "85%";
    div.style.marginBottom = "5px";
    div.style.fontSize = "11px";

    if (role === 'user') {
        div.style.background = "#007bff";
        div.style.color = "white";
        div.style.alignSelf = "flex-end";
    } else {
        div.style.background = "#e9ecef";
        div.style.color = "#333";
        div.style.alignSelf = "flex-start";
    }
    div.innerText = text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}


// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¿½åŠ ã™ã‚‹é–¢æ•°
function addAiMessage(text, type) {
    const container = document.getElementById('ai-chat-messages');
    const div = document.createElement('div');
    div.className = `ai-message ${type}`;
    div.innerText = text; // å®‰å…¨ã®ãŸã‚innerTextã‚’ä½¿ç”¨
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å‰Šé™¤ç”¨ã®ID
    const msgId = Date.now();
    div.setAttribute('data-msg-id', msgId);

    container.appendChild(div);
    container.scrollTop = container.scrollHeight; // ä¸€ç•ªä¸‹ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    return msgId;
}

</script>
</body>
</html>